<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ</title>
  <meta name="description" content="ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ê³¼ ê´€ê´‘ëª…ì†Œ ì¶”ì²œ, ê²€ìƒ‰, ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ ì œê³µ" />
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ì£¼ë³€ êµí†µ(ì—­/ì •ë¥˜ì¥) ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .transit {
      margin-top:14px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
      font-size:.85rem;
    }
    .transit h3 {
      margin:0 0 8px;
      font-size:.9rem;
      font-weight:700;
    }
    .transit-list {
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .transit-item {
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.3;
    }
    .transit-item .icon { font-size:1rem; }
    .transit-item .name { font-weight:600; }
    .transit-item .distance { color:var(--muted); font-size:.78rem; }
    .transit-empty { color:var(--muted); font-size:.78rem; }

    /* ì£¼ë³€ ë§›ì§‘ íŒì—… */
    .nearby-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:120}
    .nearby-backdrop.show{display:flex}
    .nearby-modal{width:min(520px,92%);background:var(--bg);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.25);overflow:hidden}
    .nearby-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .nearby-close{border:1px solid var(--border);background:transparent;border-radius:10px;padding:6px 10px;cursor:pointer}
    .nearby-body{padding:14px;max-height:60vh;overflow:auto}
    .nearby-list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:10px}
    .nearby-item{border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--card);display:flex;flex-direction:column;gap:6px}
    .nearby-item .name{font-weight:700}
    .nearby-item .addr{font-size:.88rem;color:var(--muted)}
    .nearby-item .actions{display:flex;gap:8px}
    .nearby-item .btn-link{border:1px solid var(--border);background:var(--bg);border-radius:8px;padding:6px 10px;font-size:.86rem;text-decoration:none;color:inherit}
    .nearby-meta{display:flex;align-items:center;gap:8px;font-size:.72rem;}
    #nearbyLoc{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--muted);max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .nearby-reload{border:1px solid var(--border);background:var(--card);color:var(--text);padding:4px 10px;border-radius:8px;font-size:.7rem;cursor:pointer;}
    .nearby-reload:hover{background:var(--bg);}

    /* í‰ì  í‘œì‹œ */
    .nearby-rating{display:flex;align-items:center;gap:6px;font-size:.78rem;}
    .nearby-rating .rating-value{font-weight:600;color:var(--text);}
    .nearby-rating .stars{font-size:.72rem;letter-spacing:1px;color:#fbbf24;}
  </style>
  <!-- Kakao Maps SDK: ì‹¤ì œ ì•±í‚¤ë¡œ êµì²´ -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9ea6307d093424b5d332f6838987fb7d&libraries=services"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="nav">
        <div class="brand">
          <div class="logo">TR</div>
          <div>ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ</div>
        </div>
        <div class="tools">
          <button id="toggleTheme" class="btn" aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">ë‹¤í¬ ëª¨ë“œ</button>
          <button id="showFavorites" class="btn" aria-label="ì¦ê²¨ì°¾ê¸° ë³´ê¸°">ì¦ê²¨ì°¾ê¸°</button>
          <a class="btn-primary btn" href="#submit" aria-label="ì¥ì†Œ ì œì•ˆ">ì¥ì†Œ ì œì•ˆí•˜ê¸°</a>
        </div>
      </div>
      <div class="searchbar">
        <div class="search-controls">
          <div class="search-input" role="search" aria-label="ê²€ìƒ‰ì°½ ë˜í¼">
            <input id="q" type="search" placeholder="ë„ì‹œ, ì¥ì†Œëª…, ë©”ë‰´, í‚¤ì›Œë“œ ê²€ìƒ‰" aria-label="ê²€ìƒ‰" />
            <button class="search-icon" aria-hidden="true" tabindex="-1">
              <!-- ê°„ë‹¨í•œ ë‹ë³´ê¸° SVG -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
            </button>
          </div>
          <button id="filterBtn" class="btn filter-btn" aria-expanded="false" aria-controls="filterMenu" title="í•„í„°">í•„í„°</button>
          <button id="clear" class="btn" aria-label="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
          <!-- ë‚´ ìœ„ì¹˜ ì°¾ê¸° ë²„íŠ¼ ì¶”ê°€ -->
          <button id="btnMyLocation" class="btn" type="button">ë‚´ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸°</button>
        </div>
        <!-- í•„í„° ë“œë¡­ë‹¤ìš´: ê¸°ì¡´ ì…€ë ‰íŠ¸ëŠ” ì—¬ê¸°ë¡œ ì´ë™(ì•„ì´ë”” ë™ì¼) -->
        <div id="filterMenu" class="filter-menu" hidden>
          <div class="filter-row">
            <label>ì •ë ¬</label>
            <select id="sort" class="input" aria-label="ì •ë ¬">
              <option value="popular">ì¸ê¸°ìˆœ</option>
              <option value="rating">í‰ì ìˆœ</option>
              <option value="recent">ìµœì‹ ìˆœ</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ë„ì‹œ</label>
            <select id="city" class="input" aria-label="ë„ì‹œ ì„ íƒ">
              <option value="">ì „ì²´ ë„ì‹œ</option>
              <option>ë¶€ì‚°</option>
              <option>ì„œìš¸</option>
              <option>ì œì£¼</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ìš”ë¦¬</label>
            <select id="cuisine" class="input" aria-label="ìš”ë¦¬ ì¢…ë¥˜">
              <option value="">ì „ì²´ ìš”ë¦¬</option>
              <option value="korean">í•œì‹</option>
              <option value="western">ì–‘ì‹</option>
              <option value="chinese">ì¤‘ì‹</option>
              <option value="japanese">ì¼ì‹</option>
              <option value="fusion">í“¨ì „/ê¸°íƒ€</option>
              <option value="other">ê¸°íƒ€</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ì—°ë ¹ëŒ€</label>
            <select id="ageFilter" class="input" aria-label="ì—°ë ¹ëŒ€ ì„ íƒ">
              <option value="">ì „ì²´ ì—°ë ¹ëŒ€</option>
              <option value="10s">10ëŒ€</option>
              <option value="20s">20ëŒ€</option>
              <option value="30s">30ëŒ€</option>
              <option value="40s">40ëŒ€</option>
              <option value="50s">50ëŒ€ ì´ìƒ</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:8px">
            <button id="applyFilters" class="btn btn-primary">ì ìš©</button>
            <button id="closeFilters" class="btn">ë‹«ê¸°</button>
          </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ì¹©ì„ ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™ -->
        <div class="chips" role="tablist" aria-label="ì¹´í…Œê³ ë¦¬" style="margin-top:12px">
          <button class="chip active" data-filter="all" role="tab" aria-selected="true">ì „ì²´</button>
          <button class="chip" data-filter="food" role="tab">ë§›ì§‘</button>
          <button class="chip" data-filter="sight" role="tab">ê´€ê´‘ëª…ì†Œ</button>
          <button class="chip" data-filter="cafe" role="tab">ì¹´í˜</button>
          <button class="chip" data-filter="night" role="tab">ì•¼ê²½/í¬ì¸íŠ¸</button>
          <button class="chip" data-filter="budget" role="tab">ê°€ì„±ë¹„</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="results">
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ë³€ê²½í•´ ë³´ì„¸ìš”.</div>
    </section>

    <section id="submit" style="margin-top:28px">
      <h2>ì¥ì†Œ ì œì•ˆí•˜ê¸°</h2>
      <p class="pill">ì•„ë˜ ì–‘ì‹ì„ í†µí•´ ì¥ì†Œë¥¼ ì œì•ˆí•´ë³´ì„¸ìš”</p>
      <form id="suggestForm" style="display:grid;gap:10px;grid-template-columns:repeat(2,1fr)">
        <input class="input" name="name" placeholder="ì¥ì†Œëª…" required />
        <input class="input" name="city" placeholder="ë„ì‹œ (ì˜ˆ: ë¶€ì‚°)" required />
        <input class="input" name="category" placeholder="ì¹´í…Œê³ ë¦¬ (ë§›ì§‘/ê´€ê´‘ëª…ì†Œ/ì¹´í˜ ë“±)" required />
        <input class="input" name="address" placeholder="ì£¼ì†Œ" />
        <input class="input" name="price" placeholder="ì˜ˆìƒ ê°€ê²©ëŒ€ (ì˜ˆ: 15000~30000ì›)" />
        <input class="input" name="tags" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />
        <textarea class="input" name="desc" placeholder="ì„¤ëª…" style="grid-column:1/-1" rows="4"></textarea>
        <button class="btn btn-primary" type="submit" style="grid-column:1/-1">ì œì¶œ </button>
      </form>
      <div id="suggestToast" class="pill" style="margin-top:8px"></div>
    </section>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div id="modalTitle" class="title"></div>
        <button id="modalClose" class="modal-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
        <div id="modalTags" class="tags">
          <!-- íƒœê·¸ ì•ì— í•´ì‹œíƒœê·¸(#) ì¶”ê°€ -->
          <span class="tag">#í‘ë¼ì§€</span>
          <span class="tag">#ì œì£¼</span>
          <span class="tag">#ë¡œì»¬ë§›ì§‘</span>
          <span class="tag">#ìƒì„ êµ¬ì´</span>
        </div>
        <!-- ì£¼ë³€ êµí†µ ì •ë³´ ì¶œë ¥ ì˜ì—­ ì¶”ê°€ -->
        <div id="modalTransit"></div>
        <div class="map" id="modalMap"></div>
      </div>
    </div>
  </div>

  <!-- ì£¼ë³€ ë§›ì§‘ íŒì—… -->
  <div id="nearbyBackdrop" class="nearby-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="nearby-modal">
      <div class="nearby-header">
        <div id="nearbyTitle">ë‚´ ì£¼ë³€ ë§›ì§‘</div>
        <div class="nearby-meta">
          <span id="nearbyLoc" aria-label="í˜„ì¬ ìœ„ì¹˜">ìœ„ì¹˜ í™•ì¸ ëŒ€ê¸°</span>
          <button id="nearbyReload" type="button" class="nearby-reload" aria-label="ìœ„ì¹˜ ì¬ê²€ìƒ‰">ì¬ê²€ìƒ‰</button>
        </div>
        <button id="nearbyClose" class="nearby-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
      <div class="nearby-body">
        <div id="nearbyStatus" class="pill">í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
        <ul id="nearbyList" class="nearby-list"></ul>
      </div>
    </div>
  </div>

  <footer class="container">
    <div>Â© 2025 ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ. 
    </div>
  </footer>
  <script src="data.js" defer></script>
  <script src="app.js" defer></script>
  <script>
    // DOMì— ë‚¨ì•„ìˆëŠ” "ì—°ë ¹ëŒ€ ì„ í˜¸: 10ëŒ€ 23% Â· 20ëŒ€ 15% ..." í…ìŠ¤íŠ¸ì—ì„œ ìµœë‹¤ ì—°ë ¹ëŒ€ ì¶”ì¶œ
    function extractTopAgeFromDOM(card){
      const walker = document.createTreeWalker(card, NodeFilter.SHOW_TEXT, null);
      let node, foundEl = null, text = "";
      while ((node = walker.nextNode())) {
        const t = node.nodeValue.trim();
        if (!t) continue;
        if (t.includes("ì—°ë ¹ëŒ€") || t.includes("ì„ í˜¸")) { foundEl = node.parentElement; text = foundEl.textContent; break; }
      }
      if (!foundEl || !/(\d{2})ëŒ€\s*\d+%/.test(text)) return { label:"", removeEl:null };
      let top = { grp:"", val:-1 };
      const re = /(\d{2})ëŒ€\s*(\d+)%/g;
      let m; 
      while ((m = re.exec(text))) {
        const val = parseInt(m[2],10);
        if (val > top.val) top = { grp: `${m[1]}ëŒ€`, val };
      }
      return { label: top.grp || "", removeEl: foundEl };
    }

    // ì—°ë ¹ëŒ€ ìµœë‹¤ ì„ í˜¸ ë¼ë²¨ ê³„ì‚°
    function getTopAgeLabel(agePref){
      if (!agePref) return "";
      let topKey = null, topVal = -Infinity;
      for (const [k, v] of Object.entries(agePref)){
        const num = typeof v === "number" ? v : parseFloat(String(v).replace("%","")) || 0;
        if (num > topVal){ topVal = num; topKey = k; }
      }
      if (!topKey) return "";
      const map = {"10s":"10ëŒ€","20s":"20ëŒ€","30s":"30ëŒ€","40s":"40ëŒ€","50s":"50ëŒ€"};
      const n = parseInt(topKey,10);
      return Number.isFinite(n) ? `${n}ëŒ€` : (map[topKey] || "");
    }

    function upsertAgeBadge(card){
      const anyIdEl = card.querySelector("[data-id]");
      // ë°ì´í„° ê¸°ë°˜ ìš°ì„ 
      let label = "";
      if (anyIdEl && window.PLACES) {
        const id = Number(anyIdEl.dataset.id);
        const place = (window.PLACES || []).find(p => p.id === id);
        if (place) label = getTopAgeLabel(place.agePref);
      }
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ DOM í…ìŠ¤íŠ¸ì—ì„œ íŒŒì‹±
      if (!label) {
        const fromDom = extractTopAgeFromDOM(card);
        label = fromDom.label;
        if (fromDom.removeEl) fromDom.removeEl.remove(); // ì› ë¬¸êµ¬ ì œê±°
      }

      const target = card.querySelector(".thumb") || card;
      const exists = target.querySelector(".age-badge");

      if (!label) { if (exists) exists.remove(); return; }

      if (exists) {
        exists.textContent = `${label} ì¸ê¸°`;
      } else {
        const badge = document.createElement("span");
        badge.className = "age-badge";
        badge.textContent = `${label} ì¸ê¸°`;
        target.appendChild(badge);
      }
    }

    function applyBadges(){
      const grid = document.getElementById("grid");
      if (!grid) return;
      grid.querySelectorAll(".card").forEach(upsertAgeBadge);
    }

    window.addEventListener("load", () => {
      const grid = document.getElementById("grid");
      if (!grid) return;
      applyBadges();

      const mo = new MutationObserver(muts => {
        muts.forEach(m => {
          m.addedNodes.forEach(n => {
            if (n.nodeType === 1 && n.classList.contains("card")) upsertAgeBadge(n);
          });
        });
      });
      mo.observe(grid, { childList: true, subtree: false });
    });

    /* ì£¼ë³€ êµí†µ ë°ì´í„° ë§¤í•‘ (ì¥ì†Œëª… ê¸°ë°˜) */
    const NEARBY_TRANSIT = {
      "ê²½ë³µê¶": [
        { name: "ê²½ë³µê¶ì—­ (3í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 3ë¶„" },
        { name: "ê´‘í™”ë¬¸ì—­ (5í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 8ë¶„" },
        { name: "ê²½ë³µê¶ ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 2ë¶„" }
      ],
      "ì„±ì‚°ì¼ì¶œë´‰": [
        { name: "ì„±ì‚°ì¼ì¶œë´‰ ì…êµ¬ ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 4ë¶„" },
        { name: "ì„±ì‚°í•­ ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 9ë¶„" }
      ],
      "ë¶€ì‚° ì•¼ê²½ í¬ì¸íŠ¸": [
        { name: "ë‚¨í¬ì—­ (1í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 7ë¶„" },
        { name: "ìê°ˆì¹˜ì—­ (1í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 10ë¶„" },
        { name: "ë‚¨í¬ë™ ì¤‘ì•™ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 5ë¶„" }
      ],
      "ì„œìš¸ ê°ì„± ì¹´í˜ ë¡œì§€": [
        { name: "í™ëŒ€ì…êµ¬ì—­ (2Â·ê²½ì˜ì¤‘ì•™Â·ê³µí•­ì² ë„)", type: "subway", distance: "ë„ë³´ 6ë¶„" },
        { name: "ì„œêµë™ ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 3ë¶„" }
      ]
      // í•„ìš”ì‹œ ì¶”ê°€...
    };

    function renderTransit() {
      const modalTitle = document.getElementById("modalTitle");
      const box = document.getElementById("modalTransit");
      if (!modalTitle || !box) return;
      const placeName = modalTitle.textContent.trim();
      const list = NEARBY_TRANSIT[placeName] || [];
      if (!list.length) {
        box.innerHTML = '<div class="transit"><h3>ì£¼ë³€ êµí†µ</h3><div class="transit-empty">ë“±ë¡ëœ ì£¼ë³€ ì—­/ì •ë¥˜ì¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        return;
      }
      const html = `
        <div class="transit">
          <h3>ì£¼ë³€ êµí†µ</h3>
          <ul class="transit-list">
            ${list.map(item => {
              const icon = item.type === "subway" ? "ğŸš‡" : "ğŸšŒ";
              return `<li class="transit-item"><span class="icon">${icon}</span><span class="name">${item.name}</span><span class="distance">${item.distance}</span></li>`;
            }).join("")}
          </ul>
        </div>
      `;
      box.innerHTML = html;
    }

    // ëª¨ë‹¬ í‘œì‹œ ê°ì§€(aria-hidden ë³€ê²½)
    (function observeModal(){
      const backdrop = document.getElementById("modalBackdrop");
      if (!backdrop) return;
      const applyState = () => {
        const open = backdrop.getAttribute("aria-hidden") === "false";
        document.body.classList.toggle("modal-open", open);
        if (open) setTimeout(renderTransit, 0); // ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
      };
      const obs = new MutationObserver(applyState);
      obs.observe(backdrop, { attributes:true, attributeFilter:["aria-hidden"] });
    })();

    // ì„ íƒì ìœ¼ë¡œ ëª¨ë‹¬ íƒ€ì´í‹€ ë³€ê²½ë§Œ ê°ì§€í•˜ì—¬ ì¬ë Œë”
    const modalTitleEl = document.getElementById("modalTitle");
    if (modalTitleEl) {
      const obsTitle = new MutationObserver(() => renderTransit());
      obsTitle.observe(modalTitleEl, { childList:true });
    }

    // Kakao Placesë¡œ ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰ í›„ íŒì—… í‘œì‹œ
    (function initNearbyPopup(){
      const btn = document.getElementById('btnMyLocation');
      const backdrop = document.getElementById('nearbyBackdrop');
      const closeBtn = document.getElementById('nearbyClose');
      const statusEl = document.getElementById('nearbyStatus');
      const listEl = document.getElementById('nearbyList');
      const locEl = document.getElementById('nearbyLoc');
      const reloadBtn = document.getElementById('nearbyReload');

      // ì—­ì§€ì˜¤ì½”ë”©: ìœ„ê²½ë„ -> "ë¶€ì‚° ë‚¨êµ¬" í˜•íƒœ
      function reverseGeocode(lat, lon, onDone){
        try{
          if (!window.kakao || !kakao.maps || !kakao.maps.services) {
            onDone(null);
            return;
          }
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.coord2RegionCode(lon, lat, (result, status) => {
            if (status !== kakao.maps.services.Status.OK || !result?.length) {
              onDone(null);
              return;
            }
            // í–‰ì •ë™(H) ìš°ì„ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ê²°ê³¼ ì‚¬ìš©
            const pref = result.find(r => r.region_type === 'H') || result[0];
            const sido = pref.region_1depth_name || "";
            const sigungu = pref.region_2depth_name || "";
            const text = [sido, sigungu].filter(Boolean).join(" ").trim();
            onDone(text || null);
          });
        } catch {
          onDone(null);
        }
      }

      function openPopup(){
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }
      function closePopup(){
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }
      if (closeBtn) closeBtn.addEventListener('click', closePopup);
      if (backdrop) backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closePopup(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePopup(); });

      // ì˜ì‚¬ í‰ì  ìƒì„± (ì¥ì†Œëª… ê¸°ë°˜ í•´ì‹œ => 3.5~5.0)
      function pseudoRating(name){
        let h = 0;
        for (let i=0;i<name.length;i++){
          h = (h * 31 + name.charCodeAt(i)) >>> 0;
        }
        const frac = (h % 1000) / 1000;            // 0~0.999
        const rating = 3.5 + frac * 1.5;           // 3.5 ~ 5.0
        return Math.round(rating * 10) / 10;       // í•œ ìë¦¬ ì†Œìˆ˜
      }
      // ì ˆë°˜ ë³„(Â½) ì œê±°: ì •ìˆ˜ ê°œìˆ˜ì˜ ë³„ë§Œ í‘œì‹œ
      function makeStars(r){
        const n = Math.max(0, Math.min(5, Math.round(r))); // 0~5
        return 'â˜…'.repeat(n) + 'â˜†'.repeat(5 - n);
      }

      function renderPlaces(data){
        listEl.innerHTML = "";
        if (!data || !data.length){
          statusEl.textContent = "ì£¼ë³€ ë§›ì§‘ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        statusEl.textContent = `ì£¼ë³€ ë§›ì§‘ ${data.length}ê³³`;
        data.slice(0,10).forEach(place => {
          const rating = pseudoRating(place.place_name);
          const stars = makeStars(rating);
          const li = document.createElement('li');
            li.className = 'nearby-item';
            li.innerHTML = `
              <div class="name">${place.place_name}</div>
              <div class="nearby-rating" aria-label="í‰ì  ${rating}">
                <span class="rating-value">${rating}</span>
                <span class="stars" aria-hidden="true">${stars}</span>
              </div>
              <div class="addr">${place.road_address_name || place.address_name || ""}</div>
              <div class="actions">
                ${place.place_url ? `<a class="btn-link" href="${place.place_url}" target="_blank" rel="noopener">ìƒì„¸ë³´ê¸°</a>`:""}
                ${place.phone ? `<a class="btn-link" href="tel:${place.phone}">ì „í™”</a>`:""}
              </div>
            `;
          listEl.appendChild(li);
        });
      }

      function searchKakaoPlaces(lat, lon){
        if (!window.kakao || !kakao.maps || !kakao.maps.services){
          statusEl.textContent = "Kakao Mapsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
          return;
        }
        statusEl.textContent = "ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰ ì¤‘...";
        const ps = new kakao.maps.services.Places();
        ps.keywordSearch(
          'ë§›ì§‘',
          (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
              renderPlaces(data);
            } else {
              statusEl.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
          },
          { location: new kakao.maps.LatLng(lat, lon), radius: 2000 }
        );
      }

      function getLocationAndSearch(){
        if (!('geolocation' in navigator)){
          alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        if (locEl) locEl.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
        statusEl.textContent = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
        listEl.innerHTML = "";
        openPopup();
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            // ì¢Œí‘œ -> í–‰ì •êµ¬ì—­ëª… í‘œì‹œ
            reverseGeocode(lat, lon, (text) => {
              if (locEl) {
                locEl.textContent = text || `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
              }
            });
            statusEl.textContent = "ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰ ì¤‘...";
            searchKakaoPlaces(lat, lon);
          },
          (err)=>{
            statusEl.textContent = `ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${err.message}`;
            if (locEl) locEl.textContent = 'ì˜¤ë¥˜';
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      }

      if (btn) btn.addEventListener('click', getLocationAndSearch);
      if (reloadBtn) reloadBtn.addEventListener('click', getLocationAndSearch);
    })();
  </script>
</body>
</html>