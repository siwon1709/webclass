<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ</title>
  <meta name="description" content="ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ê³¼ ê´€ê´‘ëª…ì†Œ ì¶”ì²œ, ê²€ìƒ‰, ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ ì œê³µ" />
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ì£¼ë³€ êµí†µ(ì—­/ì •ë¥˜ì¥) ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .transit {
      margin-top:14px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
      font-size:.85rem;
    }
    .transit h3 {
      margin:0 0 8px;
      font-size:.9rem;
      font-weight:700;
    }
    .transit-list {
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .transit-item {
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.3;
    }
    .transit-item .icon { font-size:1rem; }
    .transit-item .name { font-weight:600; }
    .transit-item .distance { color:var(--muted); font-size:.78rem; }
    .transit-empty { color:var(--muted); font-size:.78rem; }

    /* ë§Œì¡±ë„ ì¡°ì‚¬ íŒì—… ìŠ¤íƒ€ì¼ */
    .survey-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .survey-backdrop.show {
      opacity: 1;
      pointer-events: all;
    }
    .survey-modal {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .survey-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .survey-header button {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .survey-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .stars {
      display: flex;
      gap: 4px;
    }
    .star-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    .star-btn:hover {
      transform: scale(1.2);
    }
    .star-btn.active svg {
      fill: gold;
    }
    .survey-comment {
      resize: none;
      height: 60px;
    }
    .survey-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .disable-7d {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="nav">
        <div class="brand">
          <div class="logo">TR</div>
          <div>ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ</div>
        </div>
        <div class="tools">
          <button id="toggleTheme" class="btn" aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">ë‹¤í¬ ëª¨ë“œ</button>
          <button id="showFavorites" class="btn" aria-label="ì¦ê²¨ì°¾ê¸° ë³´ê¸°">ì¦ê²¨ì°¾ê¸°</button>
          <a class="btn-primary btn" href="#submit" aria-label="ì¥ì†Œ ì œì•ˆ">ì¥ì†Œ ì œì•ˆí•˜ê¸°</a>
        </div>
      </div>
      <div class="searchbar">
        <div class="search-controls">
          <div class="search-input" role="search" aria-label="ê²€ìƒ‰ì°½ ë˜í¼">
            <input id="q" type="search" placeholder="ë„ì‹œ, ì¥ì†Œëª…, ë©”ë‰´, í‚¤ì›Œë“œ ê²€ìƒ‰" aria-label="ê²€ìƒ‰" />
            <button class="search-icon" aria-hidden="true" tabindex="-1">
              <!-- ê°„ë‹¨í•œ ë‹ë³´ê¸° SVG -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
            </button>
          </div>
          <button id="filterBtn" class="btn filter-btn" aria-expanded="false" aria-controls="filterMenu" title="í•„í„°">í•„í„°</button>
          <button id="clear" class="btn" aria-label="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
        </div>
        <!-- í•„í„° ë“œë¡­ë‹¤ìš´: ê¸°ì¡´ ì…€ë ‰íŠ¸ëŠ” ì—¬ê¸°ë¡œ ì´ë™(ì•„ì´ë”” ë™ì¼) -->
        <div id="filterMenu" class="filter-menu" hidden>
          <div class="filter-row">
            <label>ì •ë ¬</label>
            <select id="sort" class="input" aria-label="ì •ë ¬">
              <option value="popular">ì¸ê¸°ìˆœ</option>
              <option value="rating">í‰ì ìˆœ</option>
              <option value="recent">ìµœì‹ ìˆœ</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ë„ì‹œ</label>
            <select id="city" class="input" aria-label="ë„ì‹œ ì„ íƒ">
              <option value="">ì „ì²´ ë„ì‹œ</option>
              <option>ë¶€ì‚°</option>
              <option>ì„œìš¸</option>
              <option>ì œì£¼</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ìš”ë¦¬</label>
            <select id="cuisine" class="input" aria-label="ìš”ë¦¬ ì¢…ë¥˜">
              <option value="">ì „ì²´ ìš”ë¦¬</option>
              <option value="korean">í•œì‹</option>
              <option value="western">ì–‘ì‹</option>
              <option value="chinese">ì¤‘ì‹</option>
              <option value="japanese">ì¼ì‹</option>
              <option value="fusion">í“¨ì „/ê¸°íƒ€</option>
              <option value="other">ê¸°íƒ€</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ì—°ë ¹ëŒ€</label>
            <select id="ageFilter" class="input" aria-label="ì—°ë ¹ëŒ€ ì„ íƒ">
              <option value="">ì „ì²´ ì—°ë ¹ëŒ€</option>
              <option value="10s">10ëŒ€</option>
              <option value="20s">20ëŒ€</option>
              <option value="30s">30ëŒ€</option>
              <option value="40s">40ëŒ€</option>
              <option value="50s">50ëŒ€ ì´ìƒ</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:8px">
            <button id="applyFilters" class="btn btn-primary">ì ìš©</button>
            <button id="closeFilters" class="btn">ë‹«ê¸°</button>
          </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ì¹©ì„ ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™ -->
        <div class="chips" role="tablist" aria-label="ì¹´í…Œê³ ë¦¬" style="margin-top:12px">
          <button class="chip active" data-filter="all" role="tab" aria-selected="true">ì „ì²´</button>
          <button class="chip" data-filter="food" role="tab">ë§›ì§‘</button>
          <button class="chip" data-filter="sight" role="tab">ê´€ê´‘ëª…ì†Œ</button>
          <button class="chip" data-filter="cafe" role="tab">ì¹´í˜</button>
          <button class="chip" data-filter="night" role="tab">ì•¼ê²½/í¬ì¸íŠ¸</button>
          <button class="chip" data-filter="budget" role="tab">ê°€ì„±ë¹„</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="results">
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ë³€ê²½í•´ ë³´ì„¸ìš”.</div>
    </section>

    <section id="submit" style="margin-top:28px">
      <h2>ì¥ì†Œ ì œì•ˆí•˜ê¸°</h2>
      <p class="pill">ì•„ë˜ ì–‘ì‹ì„ í†µí•´ ì¥ì†Œë¥¼ ì œì•ˆí•´ë³´ì„¸ìš”</p>
      <form id="suggestForm" style="display:grid;gap:10px;grid-template-columns:repeat(2,1fr)">
        <input class="input" name="name" placeholder="ì¥ì†Œëª…" required />
        <input class="input" name="city" placeholder="ë„ì‹œ (ì˜ˆ: ë¶€ì‚°)" required />
        <input class="input" name="category" placeholder="ì¹´í…Œê³ ë¦¬ (ë§›ì§‘/ê´€ê´‘ëª…ì†Œ/ì¹´í˜ ë“±)" required />
        <input class="input" name="address" placeholder="ì£¼ì†Œ" />
        <input class="input" name="price" placeholder="ì˜ˆìƒ ê°€ê²©ëŒ€ (ì˜ˆ: 15000~30000ì›)" />
        <input class="input" name="tags" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />
        <textarea class="input" name="desc" placeholder="ì„¤ëª…" style="grid-column:1/-1" rows="4"></textarea>
        <button class="btn btn-primary" type="submit" style="grid-column:1/-1">ì œì¶œ </button>
      </form>
      <div id="suggestToast" class="pill" style="margin-top:8px"></div>
    </section>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div id="modalTitle" class="title"></div>
        <button id="modalClose" class="modal-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
        <div id="modalTags" class="tags">
          <!-- íƒœê·¸ ì•ì— í•´ì‹œíƒœê·¸(#) ì¶”ê°€ -->
          <span class="tag">#í‘ë¼ì§€</span>
          <span class="tag">#ì œì£¼</span>
          <span class="tag">#ë¡œì»¬ë§›ì§‘</span>
          <span class="tag">#ìƒì„ êµ¬ì´</span>
        </div>
        <!-- ì£¼ë³€ êµí†µ ì •ë³´ ì¶œë ¥ ì˜ì—­ ì¶”ê°€ -->
        <div id="modalTransit"></div>
        <div class="map" id="modalMap"></div>
      </div>
    </div>
  </div>

  <!-- ë§Œì¡±ë„ ì¡°ì‚¬ íŒì—… -->
  <div id="surveyBackdrop" class="survey-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="survey-modal">
      <div class="survey-header">
        <div>ì‚¬ì´íŠ¸ ë§Œì¡±ë„ ì¡°ì‚¬</div>
        <button id="surveyClose" class="survey-close" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="survey-body">
        <div>ì‚¬ì´íŠ¸ì— ëŒ€í•´ ì–¼ë§ˆë‚˜ ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?</div>
        <div class="stars" id="surveyStars" role="radiogroup" aria-label="ë§Œì¡±ë„ ë³„ì ">
          <button class="star-btn" type="button" data-value="1" aria-label="1ì " aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          <button class="star-btn" type="button" data-value="2" aria-label="2ì " aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          <button class="star-btn" type="button" data-value="3" aria-label="3ì " aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          <button class="star-btn" type="button" data-value="4" aria-label="4ì " aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          <button class="star-btn" type="button" data-value="5" aria-label="5ì " aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
        </div>
        <textarea id="surveyComment" class="input survey-comment" placeholder="ì½”ë©˜íŠ¸(ì„ íƒ)"></textarea>
        <div class="survey-actions">
          <button id="surveySkip7d" class="disable-7d" type="button">7ì¼ê°„ ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°</button>
          <button id="surveySubmit" class="btn btn-primary" type="button">ì œì¶œ</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="container">
    <div>Â© 2025 ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ. 
    </div>
  </footer>
  <script src="data.js" defer></script>
  <script src="app.js" defer></script>
  <script>
    // DOMì— ë‚¨ì•„ìˆëŠ” "ì—°ë ¹ëŒ€ ì„ í˜¸: 10ëŒ€ 23% Â· 20ëŒ€ 15% ..." í…ìŠ¤íŠ¸ì—ì„œ ìµœë‹¤ ì—°ë ¹ëŒ€ ì¶”ì¶œ
    function extractTopAgeFromDOM(card){
      const walker = document.createTreeWalker(card, NodeFilter.SHOW_TEXT, null);
      let node, foundEl = null, text = "";
      while ((node = walker.nextNode())) {
        const t = node.nodeValue.trim();
        if (!t) continue;
        if (t.includes("ì—°ë ¹ëŒ€") || t.includes("ì„ í˜¸")) { foundEl = node.parentElement; text = foundEl.textContent; break; }
      }
      if (!foundEl || !/(\d{2})ëŒ€\s*\d+%/.test(text)) return { label:"", removeEl:null };
      let top = { grp:"", val:-1 };
      const re = /(\d{2})ëŒ€\s*(\d+)%/g;
      let m; 
      while ((m = re.exec(text))) {
        const val = parseInt(m[2],10);
        if (val > top.val) top = { grp: `${m[1]}ëŒ€`, val };
      }
      return { label: top.grp || "", removeEl: foundEl };
    }

    // ì—°ë ¹ëŒ€ ìµœë‹¤ ì„ í˜¸ ë¼ë²¨ ê³„ì‚°
    function getTopAgeLabel(agePref){
      if (!agePref) return "";
      let topKey = null, topVal = -Infinity;
      for (const [k, v] of Object.entries(agePref)){
        const num = typeof v === "number" ? v : parseFloat(String(v).replace("%","")) || 0;
        if (num > topVal){ topVal = num; topKey = k; }
      }
      if (!topKey) return "";
      const map = {"10s":"10ëŒ€","20s":"20ëŒ€","30s":"30ëŒ€","40s":"40ëŒ€","50s":"50ëŒ€"};
      const n = parseInt(topKey,10);
      return Number.isFinite(n) ? `${n}ëŒ€` : (map[topKey] || "");
    }

    function upsertAgeBadge(card){
      const anyIdEl = card.querySelector("[data-id]");
      // ë°ì´í„° ê¸°ë°˜ ìš°ì„ 
      let label = "";
      if (anyIdEl && window.PLACES) {
        const id = Number(anyIdEl.dataset.id);
        const place = (window.PLACES || []).find(p => p.id === id);
        if (place) label = getTopAgeLabel(place.agePref);
      }
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ DOM í…ìŠ¤íŠ¸ì—ì„œ íŒŒì‹±
      if (!label) {
        const fromDom = extractTopAgeFromDOM(card);
        label = fromDom.label;
        if (fromDom.removeEl) fromDom.removeEl.remove(); // ì› ë¬¸êµ¬ ì œê±°
      }

      const target = card.querySelector(".thumb") || card;
      const exists = target.querySelector(".age-badge");

      if (!label) { if (exists) exists.remove(); return; }

      if (exists) {
        exists.textContent = `${label} ì¸ê¸°`;
      } else {
        const badge = document.createElement("span");
        badge.className = "age-badge";
        badge.textContent = `${label} ì¸ê¸°`;
        target.appendChild(badge);
      }
    }

    function applyBadges(){
      const grid = document.getElementById("grid");
      if (!grid) return;
      grid.querySelectorAll(".card").forEach(upsertAgeBadge);
    }

    window.addEventListener("load", () => {
      const grid = document.getElementById("grid");
      if (!grid) return;
      applyBadges();

      const mo = new MutationObserver(muts => {
        muts.forEach(m => {
          m.addedNodes.forEach(n => {
            if (n.nodeType === 1 && n.classList.contains("card")) upsertAgeBadge(n);
          });
        });
      });
      mo.observe(grid, { childList: true, subtree: false });
    });

    /* ì£¼ë³€ êµí†µ ë°ì´í„° ë§¤í•‘ (ì¥ì†Œëª… ê¸°ë°˜) */
    const NEARBY_TRANSIT = {
      "ê²½ë³µê¶": [
        { name: "ê²½ë³µê¶ì—­ (3í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 3ë¶„" },
        { name: "ê´‘í™”ë¬¸ì—­ (5í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 8ë¶„" },
        { name: "ê²½ë³µê¶ ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 2ë¶„" }
      ],
      "ì„±ì‚°ì¼ì¶œë´‰": [
        { name: "ì„±ì‚°ì¼ì¶œë´‰ ì…êµ¬ ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 4ë¶„" },
        { name: "ì„±ì‚°í•­ ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 9ë¶„" }
      ],
      "ë¶€ì‚° ì•¼ê²½ í¬ì¸íŠ¸": [
        { name: "ë‚¨í¬ì—­ (1í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 7ë¶„" },
        { name: "ìê°ˆì¹˜ì—­ (1í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 10ë¶„" },
        { name: "ë‚¨í¬ë™ ì¤‘ì•™ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 5ë¶„" }
      ],
      "ì„œìš¸ ê°ì„± ì¹´í˜ ë¡œì§€": [
        { name: "í™ëŒ€ì…êµ¬ì—­ (2Â·ê²½ì˜ì¤‘ì•™Â·ê³µí•­ì² ë„)", type: "subway", distance: "ë„ë³´ 6ë¶„" },
        { name: "ì„œêµë™ ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 3ë¶„" }
      ]
      // í•„ìš”ì‹œ ì¶”ê°€...
    };

    function renderTransit() {
      const modalTitle = document.getElementById("modalTitle");
      const box = document.getElementById("modalTransit");
      if (!modalTitle || !box) return;
      const placeName = modalTitle.textContent.trim();
      const list = NEARBY_TRANSIT[placeName] || [];
      if (!list.length) {
        box.innerHTML = '<div class="transit"><h3>ì£¼ë³€ êµí†µ</h3><div class="transit-empty">ë“±ë¡ëœ ì£¼ë³€ ì—­/ì •ë¥˜ì¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        return;
      }
      const html = `
        <div class="transit">
          <h3>ì£¼ë³€ êµí†µ</h3>
          <ul class="transit-list">
            ${list.map(item => {
              const icon = item.type === "subway" ? "ğŸš‡" : "ğŸšŒ";
              return `<li class="transit-item"><span class="icon">${icon}</span><span class="name">${item.name}</span><span class="distance">${item.distance}</span></li>`;
            }).join("")}
          </ul>
        </div>
      `;
      box.innerHTML = html;
    }

    // ëª¨ë‹¬ í‘œì‹œ ê°ì§€(aria-hidden ë³€ê²½)
    (function observeModal(){
      const backdrop = document.getElementById("modalBackdrop");
      if (!backdrop) return;
      const applyState = () => {
        const open = backdrop.getAttribute("aria-hidden") === "false";
        document.body.classList.toggle("modal-open", open);
        if (open) setTimeout(renderTransit, 0); // ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
      };
      const obs = new MutationObserver(applyState);
      obs.observe(backdrop, { attributes:true, attributeFilter:["aria-hidden"] });
    })();

    // ì„ íƒì ìœ¼ë¡œ ëª¨ë‹¬ íƒ€ì´í‹€ ë³€ê²½ë§Œ ê°ì§€í•˜ì—¬ ì¬ë Œë”
    const modalTitleEl = document.getElementById("modalTitle");
    if (modalTitleEl) {
      const obsTitle = new MutationObserver(() => renderTransit());
      obsTitle.observe(modalTitleEl, { childList:true });
    }

    // ë§Œì¡±ë„ ì¡°ì‚¬ íŒì—… ë¡œì§
    (function initSurvey(){
      const backdrop = document.getElementById('surveyBackdrop');
      const stars = document.getElementById('surveyStars');
      const submitBtn = document.getElementById('surveySubmit');
      const closeBtn = document.getElementById('surveyClose');
      const skip7dBtn = document.getElementById('surveySkip7d');
      const commentEl = document.getElementById('surveyComment');

      let rating = 0;

      function canShow() {
        const done = localStorage.getItem('survey_done') === '1';
        const blockUntil = parseInt(localStorage.getItem('survey_block_until') || '0', 10);
        const sessionShown = sessionStorage.getItem('survey_shown') === '1';
        return !done && Date.now() > blockUntil && !sessionShown;
      }
      function show() {
        if (!backdrop) return;
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden', 'false');
        sessionStorage.setItem('survey_shown', '1'); // ì´ ì„¸ì…˜ì— 1íšŒë§Œ
      }
      function hide() {
        if (!backdrop) return;
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden', 'true');
      }
      function paintStars(n){
        rating = n;
        const btns = stars ? stars.querySelectorAll('.star-btn') : [];
        btns.forEach(btn => {
          const v = Number(btn.dataset.value);
          const active = v <= n;
          btn.classList.toggle('active', active);
          btn.setAttribute('aria-pressed', String(active));
        });
      }

      if (stars) {
        stars.addEventListener('click', (e) => {
          const btn = e.target.closest('.star-btn');
          if (!btn) return;
          paintStars(Number(btn.dataset.value));
        });
      }
      if (closeBtn) {
        closeBtn.addEventListener('click', hide);
      }
      if (skip7dBtn) {
        skip7dBtn.addEventListener('click', () => {
          const until = Date.now() + 7*24*60*60*1000;
          localStorage.setItem('survey_block_until', String(until));
          hide();
        });
      }
      if (submitBtn) {
        submitBtn.addEventListener('click', () => {
          if (rating < 1) { alert('ë³„ì ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
          const payload = {
            rating,
            comment: (commentEl?.value || '').trim(),
            at: new Date().toISOString()
          };
          // ì‹¤ì œ ì „ì†¡ì´ ì—†ë‹¤ë©´ ë¡œì»¬ì— ì €ì¥ë§Œ
          localStorage.setItem('survey_result', JSON.stringify(payload));
          localStorage.setItem('survey_done', '1'); // 1íšŒë§Œ í‘œì‹œ
          hide();
          alert('ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
        });
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hide();
      });

      // 30ì´ˆ í›„ í‘œì‹œ (ì¡°ê±´ ì¶©ì¡± ì‹œ)
      window.addEventListener('load', () => {
        setTimeout(() => { if (canShow()) show(); }, 30000);
      });
    })();
  </script>
</body>
</html>